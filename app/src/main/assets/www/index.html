<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>WordStudio</title>

  <style>
    :root{
      --bg:#fff;
      --soft:#f7f7f8;
      --line:#e6e6e6;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --danger:#dc2626;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);

      --barH: 56px;      /* una riga */
      --adH: 60px;       /* spazio banner */
      --kbPad: 0px;      /* padding tastiera */
      --shadow: 0 10px 26px rgba(0,0,0,.06);
      --shadow2: 0 4px 14px rgba(0,0,0,.05);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior:none;
    }

    .app{ min-height:100%; display:flex; flex-direction:column; }

    /* Top (solo brand + nome file) */
    .top{
      position:sticky;
      top:0;
      z-index:30;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding: calc(10px + var(--safeTop)) 12px 10px;
    }
    .topInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:var(--primary);
      display:grid;place-items:center;
      color:#fff;font-weight:900;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .brandText{ line-height:1.1; }
    .brandText .t{ font-size:16px; font-weight:900; }
    .brandText .s{ font-size:12px; font-weight:700; color:var(--muted); }

    .nameWrap{ flex:1; display:flex; justify-content:flex-end; min-width:0; }
    .fileName{
      width:min(520px,100%);
      height:44px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:0 14px;
      font-weight:800;
      font-size:14px;
      outline:none;
      background:#fff;
    }

    /* Toolbar: una riga scorrevole */
    .barWrap{
      position:sticky;
      top: calc(68px + var(--safeTop));
      z-index:25;
      background:var(--soft);
      border-bottom:1px solid var(--line);
    }
    .bar{
      max-width:1100px;
      margin:0 auto;
      height: var(--barH);
      padding: 8px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .bar::-webkit-scrollbar{ display:none; }

    .seg{
      display:inline-flex;
      align-items:center;
      gap:8px;
      height:40px;
      padding:0 10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
      white-space:nowrap;
    }

    .btn{
      height:36px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 12px;
      font-weight:900;
      font-size:13px;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      flex:0 0 auto;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.danger{ border-color: rgba(220,38,38,.35); color:var(--danger); }

    .dot{
      width:22px;height:22px;border-radius:8px;
      border:1px solid var(--line);
      background:#111827;
      flex:0 0 auto;
    }
    input[type="color"]{
      width:34px;height:34px;border:none;background:transparent;padding:0;
      cursor:pointer; flex:0 0 auto;
    }
    .select{
      height:36px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 10px;
      font-weight:900;
      font-size:13px;
      outline:none;
      flex:0 0 auto;
    }
    .select.font{ width:190px; }
    .select.size{ width:84px; text-align-last:center; }

    /* Area documento */
    .content{
      flex:1;
      display:flex;
      justify-content:center;
      background:var(--soft);
      padding: 10px 12px calc(16px + var(--safeBot) + var(--adH) + var(--kbPad));
    }
    .page{
      width:100%;
      max-width:1100px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 60vh;
    }
    .ruler{
      height:32px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(#fff,#fff) padding-box,
        repeating-linear-gradient(to right, rgba(0,0,0,.08) 0, rgba(0,0,0,.08) 1px, transparent 1px, transparent 22px);
      opacity:.45;
    }

    /* Editor “infallibile”: textarea */
    .editor{
      flex:1;
      width:100%;
      border:none;
      outline:none;
      padding:18px 18px 30px;
      resize:none;
      font-size:16px;
      line-height:1.55;
      color:var(--text);
      background:#fff;
      font-family: Calibri, "Segoe UI", Arial, sans-serif;
    }

    /* Modali */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.24);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 12px calc(18px + var(--safeBot) + var(--adH));
      z-index:60;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:min(680px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    .modalBody{ padding:12px 14px 14px; }
    .hint{ font-size:13px; color:var(--muted); font-weight:650; margin:0 0 10px; }
    .list{ display:flex; flex-direction:column; gap:10px; max-height:45vh; overflow:auto; -webkit-overflow-scrolling:touch; }
    .row{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .meta{ min-width:0; display:flex; flex-direction:column; gap:4px; }
    .name{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .date{ font-size:12px; color:var(--muted); font-weight:700; }
    .actions{ display:flex; gap:8px; flex:0 0 auto; }
    .small{ height:36px; padding:0 12px; font-size:13px; }

    /* Toast */
    .status{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(12px + var(--safeBot) + var(--adH));
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:70;
    }
    .toast{
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(10px);
      transition:.25s ease;
      max-width:min(640px, 100%);
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateY(0); }

    /* Banner fisso */
    .adbar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      height: calc(var(--adH) + var(--safeBot));
      padding-bottom: var(--safeBot);
      background:#fff;
      border-top:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .adbox{
      height: var(--adH);
      width:min(720px, 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9ca3af;
      font-weight:900;
      font-size:12px;
      user-select:none;
    }

    @media print{
      .top, .barWrap, .ruler, .status, .adbar { display:none !important; }
      .content{ padding:0 !important; background:#fff !important; }
      .page{ border:none !important; box-shadow:none !important; border-radius:0 !important; }
      .editor{ padding:0 !important; }
    }
  </style>
</head>

<body>
<div class="app">
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <div class="logo">W</div>
        <div class="brandText">
          <div class="t">WordStudio</div>
          <div class="s">stile Word • offline</div>
        </div>
      </div>
      <div class="nameWrap">
        <input id="fileName" class="fileName" value="Documento" autocomplete="off"/>
      </div>
    </div>
  </header>

  <div class="barWrap">
    <div class="bar" id="bar">
      <div class="seg">
        <button class="btn primary" id="btnSave" type="button">Salva</button>
        <button class="btn" id="btnSaveAs" type="button">Salva con nome</button>
        <button class="btn" id="btnOpen" type="button">Apri</button>
        <button class="btn" id="btnPrint" type="button">Stampa</button>
        <button class="btn danger" id="btnTrash" type="button">Cestino</button>
      </div>

      <div class="seg">
        <span class="dot" id="dot"></span>
        <input id="color" type="color" value="#111827" aria-label="Colore testo">
      </div>

      <div class="seg">
        <select id="font" class="select font" aria-label="Font">
          <option value='Calibri, "Segoe UI", Arial, sans-serif'>Calibri (Word)</option>
          <option value='"Times New Roman", Times, serif'>Times New Roman</option>
          <option value='Georgia, serif'>Georgia</option>
          <option value='Arial, Helvetica, sans-serif'>Arial</option>
          <option value='Verdana, Geneva, sans-serif'>Verdana</option>
          <option value='"Courier New", Courier, monospace'>Courier New</option>
        </select>

        <select id="size" class="select size" aria-label="Dimensione">
          <option>12</option><option>14</option><option selected>16</option><option>18</option>
          <option>20</option><option>24</option><option>28</option><option>32</option>
        </select>
      </div>

      <div class="seg">
        <button class="btn" id="btnB" type="button"><b>B</b></button>
        <button class="btn" id="btnI" type="button"><i>I</i></button>
        <button class="btn" id="btnU" type="button"><u>U</u></button>
        <button class="btn" id="btnS" type="button"><span style="text-decoration:line-through;font-weight:900;">S</span></button>
      </div>
    </div>
  </div>

  <main class="content">
    <section class="page">
      <div class="ruler"></div>
      <textarea id="editor" class="editor" placeholder="Inizia a scrivere…"></textarea>
    </section>
  </main>

  <!-- Modal Apri -->
  <div class="modalBack" id="openModal" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>Apri documento</div>
        <button class="btn small" id="closeOpen" type="button">Chiudi</button>
      </div>
      <div class="modalBody">
        <p class="hint">Documenti salvati offline su questo dispositivo.</p>
        <div class="list" id="docList"></div>
      </div>
    </div>
  </div>

  <!-- Modal Cestino -->
  <div class="modalBack" id="trashModal" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>Cestino</div>
        <button class="btn small" id="closeTrash" type="button">Chiudi</button>
      </div>
      <div class="modalBody">
        <p class="hint">Ripristina o elimina definitivamente.</p>
        <div class="list" id="trashList"></div>
      </div>
    </div>
  </div>

  <div class="status"><div class="toast" id="toast"></div></div>
</div>

<div class="adbar">
  <div class="adbox">Spazio banner AdMob (fisso)</div>
</div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  /* ===== Tastiera: evita che copra il testo ===== */
  function setKbPad(px){
    const v = Math.max(0, Math.min(px, 600));
    document.documentElement.style.setProperty("--kbPad", v + "px");
  }
  function updateKb(){
    const vv = window.visualViewport;
    if(!vv){ setKbPad(0); return; }
    const diff = Math.round(window.innerHeight - vv.height - (vv.offsetTop || 0));
    setKbPad(diff > 0 ? diff : 0);
  }
  window.addEventListener("resize", updateKb, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", updateKb, {passive:true});
    window.visualViewport.addEventListener("scroll", updateKb, {passive:true});
  }
  updateKb();

  /* ===== Tap “infallibile” ===== */
  function tap(el, fn){
    const run = (e) => { try{ e.preventDefault(); e.stopPropagation(); }catch(_){} fn(); };
    el.addEventListener("pointerdown", run, {passive:false});
    el.addEventListener("touchstart", run, {passive:false});
    el.addEventListener("click", run, {passive:false});
  }

  /* ===== Elementi ===== */
  const fileName = $("fileName");
  const editor   = $("editor");
  const toast    = $("toast");

  const btnSave  = $("btnSave");
  const btnSaveAs= $("btnSaveAs");
  const btnOpen  = $("btnOpen");
  const btnPrint = $("btnPrint");
  const btnTrash = $("btnTrash");

  const openModal = $("openModal");
  const trashModal= $("trashModal");
  const closeOpen = $("closeOpen");
  const closeTrash= $("closeTrash");
  const docList   = $("docList");
  const trashList = $("trashList");

  const color = $("color");
  const dot   = $("dot");
  const font  = $("font");
  const size  = $("size");

  const btnB = $("btnB");
  const btnI = $("btnI");
  const btnU = $("btnU");
  const btnS = $("btnS");

  /* ===== Storage keys ===== */
  const KEY_DOCS  = "ws_docs_v1";
  const KEY_TRASH = "ws_trash_v1";
  const KEY_LAST  = "ws_last_v1";
  const KEY_PREFS = "ws_prefs_v1";

  /* ===== Helpers ===== */
  let tmr = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(tmr);
    tmr = setTimeout(()=>toast.classList.remove("show"), 1600);
  }

  function loadJSON(k, fallback){
    try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
    catch(_){ return fallback; }
  }
  function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  function normalizeName(n){
    return (n||"").trim().replace(/\s+/g," ").slice(0,60) || "Documento";
  }
  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("it-IT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch(_){ return iso; }
  }

  function getDocs(){ return loadJSON(KEY_DOCS, []); }
  function setDocs(a){ saveJSON(KEY_DOCS, a); }
  function getTrash(){ return loadJSON(KEY_TRASH, []); }
  function setTrash(a){ saveJSON(KEY_TRASH, a); }

  function getCurrentName(){ return normalizeName(fileName.value); }

  /* ===== Modal ===== */
  function showModal(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
  function hideModal(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }
  [openModal, trashModal].forEach(m => m.addEventListener("click", (e)=>{ if(e.target===m) hideModal(m); }));

  /* ===== Save/Open/Trash ===== */
  function upsertDoc(name, text){
    const docs = getDocs();
    const n = normalizeName(name);
    const idx = docs.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    const entry = { name:n, text:text||"", updatedAt: nowISO() };
    if(idx >= 0) docs[idx] = entry; else docs.unshift(entry);
    setDocs(docs);
    localStorage.setItem(KEY_LAST, n);
  }

  function openDoc(name){
    const n = normalizeName(name);
    const d = getDocs().find(x => x.name.toLowerCase() === n.toLowerCase());
    if(!d) return false;
    fileName.value = d.name;
    editor.value = d.text || "";
    localStorage.setItem(KEY_LAST, d.name);
    setTimeout(()=>editor.focus(), 80);
    return true;
  }

  function moveToTrash(name){
    const n = normalizeName(name);
    const docs = getDocs();
    const idx = docs.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if(idx < 0) return false;
    const [removed] = docs.splice(idx,1);
    setDocs(docs);
    const tr = getTrash();
    tr.unshift({ ...removed, deletedAt: nowISO() });
    setTrash(tr);
    return true;
  }

  function restore(name){
    const n = normalizeName(name);
    const tr = getTrash();
    const idx = tr.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if(idx < 0) return false;
    const [rest] = tr.splice(idx,1);
    setTrash(tr);
    upsertDoc(rest.name, rest.text);
    return true;
  }

  function deleteForever(name){
    const n = normalizeName(name);
    const tr = getTrash();
    const idx = tr.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if(idx < 0) return false;
    tr.splice(idx,1);
    setTrash(tr);
    return true;
  }

  function renderDocs(){
    const docs = getDocs();
    docList.innerHTML = "";
    if(!docs.length){
      docList.innerHTML = `<div class="row"><div class="meta"><div class="name">Nessun documento</div><div class="date">Salva per vederli qui.</div></div></div>`;
      return;
    }
    docs.forEach(d => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="meta">
          <div class="name"></div>
          <div class="date"></div>
        </div>
        <div class="actions">
          <button class="btn small primary" type="button">Apri</button>
          <button class="btn small danger" type="button">Elimina</button>
        </div>`;
      row.querySelector(".name").textContent = d.name;
      row.querySelector(".date").textContent = "Aggiornato: " + fmtDate(d.updatedAt);
      const [bOpen, bDel] = row.querySelectorAll("button");
      tap(bOpen, () => { openDoc(d.name); hideModal(openModal); showToast("Documento aperto"); });
      tap(bDel,  () => { if(moveToTrash(d.name)){ renderDocs(); showToast("Spostato nel cestino"); }});
      docList.appendChild(row);
    });
  }

  function renderTrash(){
    const tr = getTrash();
    trashList.innerHTML = "";
    if(!tr.length){
      trashList.innerHTML = `<div class="row"><div class="meta"><div class="name">Cestino vuoto</div><div class="date">Nessun elemento eliminato.</div></div></div>`;
      return;
    }
    tr.forEach(d => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="meta">
          <div class="name"></div>
          <div class="date"></div>
        </div>
        <div class="actions">
          <button class="btn small" type="button">Ripristina</button>
          <button class="btn small danger" type="button">Elimina</button>
        </div>`;
      row.querySelector(".name").textContent = d.name;
      row.querySelector(".date").textContent = "Eliminato: " + fmtDate(d.deletedAt || d.updatedAt);
      const [bRes, bDel] = row.querySelectorAll("button");
      tap(bRes, () => { if(restore(d.name)){ renderTrash(); showToast("Ripristinato"); }});
      tap(bDel, () => { if(deleteForever(d.name)){ renderTrash(); showToast("Eliminato definitivamente"); }});
      trashList.appendChild(row);
    });
  }

  /* ===== Formattazione (textarea) ===== */
  function loadPrefs(){
    return loadJSON(KEY_PREFS, {
      color:"#111827",
      font: font.value,
      size: String(size.value || "16"),
      bold:false, italic:false, underline:false, strike:false
    });
  }
  function savePrefs(p){ saveJSON(KEY_PREFS, p); }

  function applyPrefs(p){
    dot.style.background = p.color;
    color.value = p.color;
    font.value = p.font;
    size.value = p.size;

    editor.style.color = p.color;
    editor.st
