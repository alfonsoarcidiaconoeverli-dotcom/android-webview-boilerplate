<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WordStudio</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --surface:#ffffff;
      --stroke:#e5e7eb;
      --stroke2:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --blue:#2563eb;   /* Word-ish accent */
      --blue2:#1d4ed8;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --r:12px;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --doc: "Calibri","Segoe UI",Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--ui);
      background:var(--bg);
      color:var(--text);
    }

    /* Top area */
    .top{
      position:sticky; top:0; z-index:10;
      background:var(--surface);
      border-bottom:1px solid var(--stroke);
    }
    .bar1{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      max-width:1200px;
      margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      flex:0 0 auto;
    }
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--blue), var(--blue2));
      color:#fff;
      display:grid; place-items:center;
      font-weight:900;
    }
    .title{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .title b{font-size:13px}
    .title small{color:var(--muted); font-weight:700; font-size:11px}

    .filebox{
      flex:1 1 auto;
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .filename{
      flex:1 1 220px;
      min-width:160px;
      border:1px solid var(--stroke);
      border-radius:10px;
      padding:9px 10px;
      font-weight:800;
      outline:none;
      background:#fff;
    }
    .filename:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .btn{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:10px;
      padding:9px 10px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .btn.danger{
      border-color:#fecaca;
      background:#fff;
      color:#b91c1c;
    }
    .btn.icon{padding:9px 11px}

    /* Ribbon */
    .bar2{
      border-top:1px solid #f3f4f6;
      padding:8px 12px;
    }
    .ribbon{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .group{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      padding:6px;
      border:1px solid var(--stroke);
      border-radius:12px;
      background:#fff;
    }
    select, input[type="number"], input[type="color"]{
      border:1px solid var(--stroke);
      border-radius:10px;
      padding:8px 9px;
      font-weight:900;
      background:#fff;
      outline:none;
    }
    input[type="number"]{width:72px; text-align:center}
    input[type="color"]{width:44px; height:40px; padding:4px}
    .tool{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      min-width:40px;
      text-align:center;
    }
    .tool.active{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    /* Main */
    .main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 12px 22px;
      display:flex;
      justify-content:center;
    }
    .paper{
      width:min(900px, 100%);
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:26px 22px;
    }
    #editor{
      min-height:72vh;
      outline:none;
      font-family:var(--doc);
      font-size:16px;
      line-height:1.65;
      color:#111827;
      word-wrap:break-word;
    }
    #editor:empty:before{
      content: attr(data-placeholder);
      color:#9ca3af;
      font-weight:700;
    }
    #editor h1{font-size:30px;margin:8px 0 10px;}
    #editor h2{font-size:22px;margin:8px 0 8px;}
    #editor p{margin:8px 0;}

    .status{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px 16px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#fff;
      border:1px solid var(--stroke);
      padding:6px 10px;
      border-radius:999px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}
    .dot.dirty{background:#f59e0b;}

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:30;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(640px, 100%);
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow: 0 20px 70px rgba(0,0,0,.2);
      overflow:hidden;
    }
    .mhead{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:1000;
    }
    .mbody{padding:14px; display:flex; flex-direction:column; gap:10px;}
    .mfoot{
      padding:12px 14px;
      border-top:1px solid var(--stroke);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .row label{min-width:90px; color:var(--muted); font-weight:900; font-size:12px}
    .row input{
      flex:1 1 280px;
      border:1px solid var(--stroke);
      border-radius:10px;
      padding:10px 10px;
      font-weight:900;
      outline:none;
    }
    .list{
      border:1px solid var(--stroke);
      border-radius:12px;
      overflow:auto;
      max-height:42vh;
    }
    .item{
      padding:10px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-top:1px solid var(--stroke);
      cursor:pointer;
    }
    .item:first-child{border-top:0}
    .item b{font-weight:1000}
    .item small{color:var(--muted); font-weight:800}
    .item.sel{outline:2px solid rgba(37,99,235,.45); outline-offset:-2px}

    /* Mobile: ribbon scroll */
    @media (max-width: 720px){
      .filebox{justify-content:flex-start}
      .ribbon{flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch}
      .ribbon::-webkit-scrollbar{height:0}
      .group{flex-wrap:nowrap; white-space:nowrap}
    }

    /* Print */
    @media print{
      body{background:#fff}
      .top,.status{display:none !important}
      .paper{box-shadow:none;border:none;border-radius:0;padding:0}
      #editor{min-height:auto}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="bar1">
      <div class="brand">
        <div class="logo">W</div>
        <div class="title">
          <b>WordStudio</b>
          <small>stile Word • offline</small>
        </div>
      </div>

      <div class="filebox">
        <input id="docName" class="filename" value="Documento" maxlength="60" />
        <button class="btn" id="openBtn" type="button">Apri</button>
        <button class="btn primary" id="saveBtn" type="button">Salva</button>
        <button class="btn" id="saveAsBtn" type="button">Salva con nome</button>
        <button class="btn" id="printBtn" type="button">Stampa</button>
        <button class="btn danger" id="trashBtn" type="button">Cestino</button>
      </div>
    </div>

    <div class="bar2">
      <div class="ribbon">
        <div class="group">
          <select id="fontSel">
            <option value="Calibri" selected>Calibri</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
          </select>
          <input id="sizeSel" type="number" min="8" max="72" value="16" />
          <input id="colorSel" type="color" value="#111827" />
        </div>

        <div class="group">
          <button class="tool" type="button" data-cmd="bold">B</button>
          <button class="tool" type="button" data-cmd="italic"><i>I</i></button>
          <button class="tool" type="button" data-cmd="underline"><u>U</u></button>
          <button class="tool" type="button" data-cmd="strikeThrough">S̶</button>
        </div>

        <div class="group">
          <select id="blockSel">
            <option value="p">Paragrafo</option>
            <option value="h1">Titolo 1</option>
            <option value="h2">Titolo 2</option>
          </select>
          <button class="tool" type="button" data-cmd="insertUnorderedList">•</button>
          <button class="tool" type="button" data-cmd="insertOrderedList">1.</button>
        </div>

        <div class="group">
          <button class="tool" type="button" data-cmd="justifyLeft">⬅</button>
          <button class="tool" type="button" data-cmd="justifyCenter">↔</button>
          <button class="tool" type="button" data-cmd="justifyRight">➡</button>
          <button class="tool" type="button" data-cmd="justifyFull">☰</button>
        </div>

        <div class="group">
          <button class="tool" type="button" id="undoBtn">↩</button>
          <button class="tool" type="button" id="redoBtn">↪</button>
        </div>

        <div class="group">
          <button class="btn icon" type="button" id="exportDocBtn">DOC</button>
          <button class="btn icon" type="button" id="exportTxtBtn">TXT</button>
          <button class="btn icon" type="button" id="exportHtmlBtn">HTML</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="paper">
      <div id="editor" contenteditable="true" spellcheck="true" data-placeholder="Scrivi qui..."></div>
    </div>
  </div>

  <div class="status">
    <div class="pill"><span id="dot" class="dot"></span><span id="saveInfo">Non salvato</span></div>
    <div class="pill">Parole: <b id="words">0</b> • Caratteri: <b id="chars">0</b></div>
  </div>

  <!-- Modal: Save As -->
  <div class="backdrop" id="saveAsModal">
    <div class="modal">
      <div class="mhead">
        <span>Salva con nome</span>
        <button class="btn" type="button" id="closeSaveAs">Chiudi</button>
      </div>
      <div class="mbody">
        <div class="row">
          <label>Nome file</label>
          <input id="saveAsName" maxlength="60" />
        </div>
        <small style="color:var(--muted);font-weight:800">
          Questo salva il documento nella libreria interna dell’app (offline).
        </small>
      </div>
      <div class="mfoot">
        <button class="btn" type="button" id="cancelSaveAs">Annulla</button>
        <button class="btn primary" type="button" id="confirmSaveAs">Salva</button>
      </div>
    </div>
  </div>

  <!-- Modal: Open -->
  <div class="backdrop" id="openModal">
    <div class="modal">
      <div class="mhead">
        <span>Apri documento</span>
        <button class="btn" type="button" id="closeOpen">Chiudi</button>
      </div>
      <div class="mbody">
        <div class="list" id="docsList"></div>
        <small style="color:var(--muted);font-weight:800">
          I documenti restano salvati nell’app. Per esportare usa DOC/TXT/HTML.
        </small>
      </div>
      <div class="mfoot">
        <button class="btn danger" type="button" id="deleteDocBtn">Elimina</button>
        <button class="btn primary" type="button" id="openSelectedBtn">Apri</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);

  const editor = $("#editor");
  const docName = $("#docName");
  const saveBtn = $("#saveBtn");
  const saveAsBtn = $("#saveAsBtn");
  const trashBtn = $("#trashBtn");
  const printBtn = $("#printBtn");
  const openBtn = $("#openBtn");

  const exportDocBtn = $("#exportDocBtn");
  const exportTxtBtn = $("#exportTxtBtn");
  const exportHtmlBtn = $("#exportHtmlBtn");

  const fontSel = $("#fontSel");
  const sizeSel = $("#sizeSel");
  const colorSel = $("#colorSel");
  const blockSel = $("#blockSel");

  const undoBtn = $("#undoBtn");
  const redoBtn = $("#redoBtn");

  const dot = $("#dot");
  const saveInfo = $("#saveInfo");
  const wordsEl = $("#words");
  const charsEl = $("#chars");

  const saveAsModal = $("#saveAsModal");
  const saveAsName = $("#saveAsName");
  const closeSaveAs = $("#closeSaveAs");
  const cancelSaveAs = $("#cancelSaveAs");
  const confirmSaveAs = $("#confirmSaveAs");

  const openModal = $("#openModal");
  const closeOpen = $("#closeOpen");
  const docsList = $("#docsList");
  const openSelectedBtn = $("#openSelectedBtn");
  const deleteDocBtn = $("#deleteDocBtn");

  // ---- Storage model (document library) ----
  const DB_KEY = "wordstudio_docs_v1";         // { docs: {id: {id,name,html,style,updatedAt}} }
  const CUR_KEY = "wordstudio_current_id_v1";

  let currentId = null;
  let selectedOpenId = null;
  let dirty = false;
  let autosaveT = null;

  function nowLabel(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }
  function uid(){
    return "doc_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function normName(n){
    n = (n || "Documento").trim().slice(0,60);
    return n.length ? n : "Documento";
  }

  function dbLoad(){
    try{
      const raw = localStorage.getItem(DB_KEY);
      if(!raw) return {docs:{}};
      const db = JSON.parse(raw);
      if(!db.docs) db.docs = {};
      return db;
    }catch(e){
      return {docs:{}};
    }
  }
  function dbSave(db){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  function setDirty(v){
    dirty = v;
    dot.classList.toggle("dirty", !!v);
    saveInfo.textContent = v ? "Modifiche non salvate" : ("Salvato alle " + nowLabel());
  }

  function applyEditorBaseStyle(){
    editor.style.fontFamily = `"${fontSel.value}", Calibri, Arial, sans-serif`;
    editor.style.fontSize = `${Math.max(8, Math.min(72, Number(sizeSel.value || 16)))}px`;
    editor.style.color = colorSel.value || "#111827";
  }

  function updateStats(){
    const t = (editor.innerText || "").replace(/\u00A0/g," ").trim();
    charsEl.textContent = String(t.length);
    wordsEl.textContent = String(t ? t.split(/\s+/).length : 0);
  }

  function snapshot(){
    return {
      id: currentId,
      name: normName(docName.value),
      html: editor.innerHTML,
      style: {
        font: fontSel.value,
        size: Number(sizeSel.value || 16),
        color: colorSel.value
      },
      updatedAt: new Date().toISOString()
    };
  }

  // ✅ SALVA SEMPRE (libreria interna)
  function saveLocal(){
    const db = dbLoad();
    if(!currentId){
      currentId = uid();
      localStorage.setItem(CUR_KEY, currentId);
    }
    const s = snapshot();
    db.docs[s.id] = s;
    dbSave(db);
    setDirty(false);
  }

  function autosave(){
    clearTimeout(autosaveT);
    autosaveT = setTimeout(() => saveLocal(), 400);
  }

  function loadDoc(id){
    const db = dbLoad();
    const d = db.docs[id];
    if(!d) return;

    currentId = d.id;
    localStorage.setItem(CUR_KEY, currentId);

    docName.value = d.name || "Documento";
    editor.innerHTML = d.html || "";

    fontSel.value = d.style?.font || "Calibri";
    sizeSel.value = String(d.style?.size || 16);
    colorSel.value = d.style?.color || "#111827";
    applyEditorBaseStyle();

    setDirty(false);
    updateStats();
  }

  function ensureInitial(){
    applyEditorBaseStyle();
    const db = dbLoad();
    const cid = localStorage.getItem(CUR_KEY);
    if(cid && db.docs[cid]){
      loadDoc(cid);
      return;
    }
    // Create first doc
    currentId = uid();
    localStorage.setItem(CUR_KEY, currentId);
    db.docs[currentId] = {
      id: currentId,
      name: "Documento",
      html: "",
      style: {font:"Calibri", size:16, color:"#111827"},
      updatedAt: new Date().toISOString()
    };
    dbSave(db);
    loadDoc(currentId);
  }

  // ---- Commands ----
  function exec(cmd, val=null){
    editor.focus();
    document.execCommand(cmd, false, val);
    setDirty(true);
    autosave();
    updateStats();
    refreshTools();
  }
  function refreshTools(){
    const cmds = ["bold","italic","underline","strikeThrough","justifyLeft","justifyCenter","justifyRight","justifyFull"];
    cmds.forEach(c=>{
      const on = document.queryCommandState(c);
      document.querySelectorAll(`.tool[data-cmd="${c}"]`).forEach(b=>b.classList.toggle("active", !!on));
    });
  }

  // ---- Modals ----
  function openSaveAs(){
    saveAsName.value = normName(docName.value);
    saveAsModal.classList.add("show");
    setTimeout(()=>saveAsName.focus(), 50);
  }
  function closeSaveAsModal(){ saveAsModal.classList.remove("show"); }

  function openOpen(){
    renderDocs();
    openModal.classList.add("show");
  }
  function closeOpenModal(){ openModal.classList.remove("show"); }

  function renderDocs(){
    const db = dbLoad();
    const docs = Object.values(db.docs).sort((a,b)=> (b.updatedAt||"").localeCompare(a.updatedAt||""));
    selectedOpenId = null;
    docsList.innerHTML = "";

    if(docs.length === 0){
      docsList.innerHTML = `<div class="item"><div><b>Nessun documento</b></div></div>`;
      return;
    }

    docs.forEach(d=>{
      const it = document.createElement("div");
      it.className = "item";
      it.dataset.id = d.id;
      it.innerHTML = `<div style="min-width:0">
        <b>${escapeHtml(d.name || "Documento")}</b><br/>
        <small>${new Date(d.updatedAt || Date.now()).toLocaleString()}</small>
      </div>
      <div><small>${(d.id||"").slice(-6).toUpperCase()}</small></div>`;
      it.addEventListener("click", ()=>{
        [...docsList.querySelectorAll(".item")].forEach(x=>x.classList.remove("sel"));
        it.classList.add("sel");
        selectedOpenId = d.id;
      });
      docsList.appendChild(it);
    });
  }

  // ---- Export ----
  // In WebView i blob download a volte non partono: usiamo data: URL.
  // Se comunque il wrapper blocca download, il documento resta salvato in “Documenti”.
  function exportDataUrl(mime, ext, content){
    saveLocal();
    const name = normName(docName.value) + "." + ext;
    const url = "data:" + mime + ";charset=utf-8," + encodeURIComponent(content);
    // forza navigazione -> spesso attiva DownloadListener del wrapper
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function buildHtmlDoc(title){
    const style = snapshot().style;
    return `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(title)}</title>
<style>body{font-family:${escapeCss(style.font)},Calibri,Arial,sans-serif;margin:36px;font-size:${style.size}px;color:#111;}</style>
</head><body>${editor.innerHTML}</body></html>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }
  function escapeCss(s){
    // basic safe
    return String(s || "Calibri").replace(/[^a-zA-Z0-9 ,\-]/g, "");
  }

  // ---- Wire UI ----
  document.querySelectorAll(".tool[data-cmd]").forEach(b=>{
    b.addEventListener("click", ()=> exec(b.dataset.cmd));
  });

  blockSel.addEventListener
