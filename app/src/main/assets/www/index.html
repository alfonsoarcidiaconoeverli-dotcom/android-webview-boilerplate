<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WordStudio</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --red:#dc2626;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --r:22px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: #f6f7fb;
      color:var(--text);
      overflow-x:hidden;
    }

    /* App shell */
    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    }

    /* Top header (solo estetica, NON comandi) */
    .top{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 10px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(180deg,#2b7cff,#1e4fd6);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 20px rgba(37,99,235,.22);
      flex: 0 0 auto;
    }
    .logo span{
      color:#fff;font-weight:900;font-size:18px;letter-spacing:.4px;
    }
    .brand{
      line-height:1.05;
      min-width: 140px;
    }
    .brand .name{ font-size:20px;font-weight:900; }
    .brand .sub{ font-size:12px;color:var(--muted);font-weight:700; margin-top:2px; }

    .docRow{
      margin-left:auto;
      display:flex; gap:10px; align-items:center;
      min-width: 0;
    }
    .docName{
      height:44px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 14px;
      font-weight:800;
      outline:none;
      min-width: 120px;
      width: min(280px, 44vw);
    }
    .pillBtn{
      height:44px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      touch-action: manipulation;
      pointer-events:auto;
    }

    /* Toolbar card */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }

    .group{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 10px;
      display:flex;
      flex-wrap: wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      height:44px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      touch-action: manipulation;
      pointer-events:auto;
      user-select:none;
    }
    .btn.primary{
      background: var(--blue);
      color:#fff;
      border-color: transparent;
      box-shadow: 0 12px 22px rgba(37,99,235,.20);
    }
    .btn.primary:active{ background: var(--blue2); }
    .btn.danger{
      color: var(--red);
      border-color: rgba(220,38,38,.35);
      background:#fff;
    }
    .btn:active{ transform: translateY(1px); }

    .iconBtn{
      width:44px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }

    .split{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .labelPill{
      height:44px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:var(--text);
      touch-action: manipulation;
      pointer-events:auto;
    }
    .swatch{
      width:26px;height:26px;border-radius:10px;
      background:#0f172a;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);
      flex:0 0 auto;
    }
    input[type="color"]{
      width:38px;height:44px;
      border:none;background:transparent;
      padding:0; margin:0;
      cursor:pointer;
      touch-action: manipulation;
      pointer-events:auto;
    }

    .select{
      height:44px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 14px;
      font-weight:900;
      font-size:14px;
      color:#111827;
      outline:none;
      touch-action: manipulation;
      pointer-events:auto;
    }
    .select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    /* Editor */
    .editorWrap{
      margin-top: 12px;
      padding: 12px;
    }
    .paper{
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 18px;
      min-height: min(64vh, 620px);
      max-height: 70vh;
      overflow:auto;

      /* IMPORTANT: evita che la tastiera copra il testo */
      padding-bottom: calc(18px + var(--kb, 0px));
    }
    .editor{
      outline:none;
      min-height: 48vh;
      font-size: 18px;
      line-height: 1.5;
      color: var(--text);
      word-break: break-word;
    }
    .editor:empty:before{
      content:"Inizia a scrivere…";
      color: #9ca3af;
      font-weight:700;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Print */
    @media print{
      body{ background:#fff; }
      .top,.toolbar{ display:none !important; }
      .app{ padding:0; max-width:none; }
      .paper{ border:none; box-shadow:none; max-height:none; overflow:visible; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header (solo titolo + input nome documento) -->
    <div class="top">
      <div class="logo" aria-hidden="true"><span>W</span></div>
      <div class="brand">
        <div class="name">WordStudio</div>
        <div class="sub">stile Word • offline</div>
      </div>

      <div class="docRow">
        <input id="docName" class="docName" value="Documento" maxlength="60" />
        <button id="btnOpenTop" class="pillBtn" type="button">Apri</button>
      </div>
    </div>

    <!-- Toolbar: TUTTI i comandi qui dentro (come mi hai chiesto) -->
    <div class="card">
      <div class="toolbar" id="toolbar">
        <!-- COMANDI FILE + FORMATT. nello stesso blocco (seconda barra) -->
        <div class="group" id="mainGroup">
          <button class="btn primary" id="btnSave" type="button">Salva</button>
          <button class="btn" id="btnSaveAs" type="button">Salva con nome</button>
          <button class="btn" id="btnPrint" type="button">Stampa</button>
          <button class="btn danger" id="btnTrash" type="button">Cestino</button>
          <button class="btn" id="btnOpen" type="button">Apri</button>

          <span style="width:100%;height:1px; background:var(--line); margin:2px 0;"></span>

          <label class="labelPill" for="colorPicker">
            <span class="swatch" id="swatch"></span>
            Colore
            <input id="colorPicker" type="color" value="#111827" />
          </label>

          <!-- FONT -->
          <select id="fontFamily" class="select" aria-label="Tipo di carattere">
            <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">Predefinito</option>
            <option value="Times New Roman, Times, serif">Times New Roman (Roman)</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="Arial, Helvetica, sans-serif">Arial</option>
            <option value="Calibri, Arial, sans-serif">Calibri</option>
            <option value="Verdana, Geneva, sans-serif">Verdana</option>
            <option value="Courier New, Courier, monospace">Courier New</option>
          </select>

          <!-- DIMENSIONI -->
          <select id="fontSize" class="select" aria-label="Dimensione carattere">
            <option value="12">12</option>
            <option value="14">14</option>
            <option value="16">16</option>
            <option value="18" selected>18</option>
            <option value="20">20</option>
            <option value="24">24</option>
            <option value="28">28</option>
            <option value="32">32</option>
          </select>

          <button class="btn iconBtn" id="btnB" type="button"><b>B</b></button>
          <button class="btn iconBtn" id="btnI" type="button"><i>I</i></button>
          <button class="btn iconBtn" id="btnU" type="button"><u>U</u></button>
          <button class="btn iconBtn" id="btnS" type="button"><s>S</s></button>

          <button class="btn" id="btnTitle" type="button">Titolo</button>
          <button class="btn" id="btnPara" type="button">Paragrafo</button>
          <button class="btn" id="btnList" type="button">• Elenco</button>
        </div>
      </div>

      <!-- Editor -->
      <div class="editorWrap">
        <div class="paper" id="paper">
          <div id="editor" class="editor" contenteditable="true" spellcheck="true"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <!-- input file nascosto -->
  <input id="fileInput" type="file" accept=".html,.txt,.docx,.md,.rtf,text/plain,text/html" style="display:none" />

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const editor = $("editor");
    const paper = $("paper");

    const docName = $("docName");

    const btnSave = $("btnSave");
    const btnSaveAs = $("btnSaveAs");
    const btnPrint = $("btnPrint");
    const btnTrash = $("btnTrash");
    const btnOpen = $("btnOpen");
    const btnOpenTop = $("btnOpenTop");

    const colorPicker = $("colorPicker");
    const swatch = $("swatch");

    const fontFamily = $("fontFamily");
    const fontSize = $("fontSize");

    const btnB = $("btnB");
    const btnI = $("btnI");
    const btnU = $("btnU");
    const btnS = $("btnS");
    const btnTitle = $("btnTitle");
    const btnPara = $("btnPara");
    const btnList = $("btnList");

    const fileInput = $("fileInput");
    const toast = $("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1100);
    }

    function hardFocusEditor(){
      // Forza focus affidabile su Android WebView
      editor.focus({preventScroll:true});
      // Piccolo "nudge" per far aggiornare la selezione in alcuni WebView
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0){
        const r = document.createRange();
        r.selectNodeContents(editor);
        r.collapse(false);
        sel?.removeAllRanges();
        sel?.addRange(r);
      }
    }

    function exec(cmd, value=null){
      hardFocusEditor();
      try{
        document.execCommand("styleWithCSS", false, true);
      }catch(e){}
      try{
        document.execCommand(cmd, false, value);
      }catch(e){}
      // Mantieni caret visibile
      requestAnimationFrame(scrollCaretIntoView);
    }

    function scrollCaretIntoView(){
      try{
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) return;
        const range = sel.getRangeAt(0).cloneRange();
        range.collapse(true);
        const rects = range.getClientRects();
        if (!rects || rects.length === 0) return;
        const rect = rects[0];
        const paperRect = paper.getBoundingClientRect();
        const y = rect.top - paperRect.top + paper.scrollTop;

        // Se caret è troppo vicino al fondo, scrolla
        const margin = 120;
        if (y > paper.scrollTop + paper.clientHeight - margin){
          paper.scrollTop = Math.min(paper.scrollHeight, y - (paper.clientHeight - margin));
        } else if (y < paper.scrollTop + 60){
          paper.scrollTop = Math.max(0, y - 60);
        }
      }catch(e){}
    }

    // ---------- Storage ----------
    const LS_INDEX = "wordstudio:index"; // { currentId, docs: {id:{name,html,updated}} }
    function loadIndex(){
      try{
        const raw = localStorage.getItem(LS_INDEX);
        if (!raw) return { currentId:null, docs:{} };
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") throw 0;
        obj.docs ||= {};
        return obj;
      }catch(e){
        return { currentId:null, docs:{} };
      }
    }
    function saveIndex(data){
      localStorage.setItem(LS_INDEX, JSON.stringify(data));
    }
    function newId(){
      return "d_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    }

    let state = loadIndex();

    function setCurrentDoc(id){
      state.currentId = id;
      saveIndex(state);
    }

    function currentDoc(){
      if (!state.currentId) return null;
      return state.docs[state.currentId] || null;
    }

    function ensureDoc(){
      if (!state.currentId || !state.docs[state.currentId]){
        const id = newId();
        state.docs[id] = {
          name: docName.value.trim() || "Documento",
          html: "",
          updated: Date.now()
        };
        setCurrentDoc(id);
        saveIndex(state);
      }
      return state.currentId;
    }

    function persistCurrent(html){
      const id = ensureDoc();
      state.docs[id].name = docName.value.trim() || "Documento";
      state.docs[id].html = html;
      state.docs[id].updated = Date.now();
      saveIndex(state);
    }

    function restore(){
      const doc = currentDoc();
      if (doc){
        docName.value = doc.name || "Documento";
        editor.innerHTML = doc.html || "";
      }else{
        // se nulla, crea documento vuoto
        ensureDoc();
        editor.innerHTML = "";
      }
    }

    // Auto-save leggero mentre scrivi
    let autosaveTimer = null;
    editor.addEventListener("input", ()=>{
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(()=>{
        persistCurrent(editor.innerHTML);
      }, 350);
      requestAnimationFrame(scrollCaretIntoView);
    });

    // ---------- File actions ----------
    function downloadText(filename, text, mime){
      const blob = new Blob([text], {type: mime || "text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    function saveNow(withName){
      const name = (docName.value || "Documento").trim();
      if (withName){
        const next = prompt("Nome documento:", name);
        if (next === null) return;
        docName.value = (next.trim() || "Documento");
      }
      persistCurrent(editor.innerHTML);
      showToast("Salvato");
    }

    function openFromPicker(){
      fileInput.value = "";
      fileInput.click();
    }

    fileInput.addEventListener("change", async ()=>{
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;

      try{
        const text = await f.text();

        // Se è HTML: prova a estrarre body, altrimenti usa testo puro
        let html = "";
        if (/<html|<body|<\/p>|<\/div>|<br/i.test(text)){
          // estrai body se presente
          const m = text.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
          html = (m ? m[1] : text).trim();
          // se contiene tag <script> o <style> dall'esterno, li rimuoviamo
          html = html.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"");
        }else{
          // testo -> converti in HTML semplice
          const safe = text
            .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/\n/g,"<br>");
          html = safe;
        }

        editor.innerHTML = html;

        // Nuovo doc
        const id = newId();
        const base = f.name.replace(/\.[^.]+$/,"") || "Documento";
        docName.value = base.slice(0,60);
        state.docs[id] = { name: docName.value, html: editor.innerHTML, updated: Date.now() };
        setCurrentDoc(id);
        saveIndex(state);

        showToast("Aperto");
        hardFocusEditor();
      }catch(e){
        showToast("Errore apertura");
      }
    });

    function emptyTrash(){
      if (!confirm("Vuoi cancellare il contenuto?")) return;
      editor.innerHTML = "";
      persistCurrent("");
      showToast("Cestino svuotato");
      hardFocusEditor();
    }

    function doPrint(){
      // salva prima di stampare
      persistCurrent(editor.innerHTML);
      showToast("Stampa…");
      setTimeout(()=>window.print(), 200);
    }

    // Export semplice (HTML)
    function exportHtmlFile(){
      const name = (docName.value || "Documento").trim();
      // documento stampabile pulito
      const html =
`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${name}</title>
<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;color:#111827} img{max-width:100%}</style>
</head><body>${editor.innerHTML}</body></html>`;
      downloadText(name + ".html", html, "text/html;charset=utf-8");
    }

    // ---------- Formatting ----------
    function applyColor(hex){
      swatch.style.background = hex;
      exec("foreColor", hex);
    }

    function applyFontFamily(v){
      hardFocusEditor();
      // prova standard
      try{ document.execCommand("fontName", false, v); }catch(e){}
      // fallback robusto
      try{
        const sel = window.getSelection();
        if (sel && sel.rangeCount){
          const range = sel.getRangeAt(0);
          if (!range.collapsed){
            const span = document.createElement("span");
            span.style.fontFamily = v;
            range.surroundContents(span);
          }
        }
      }catch(e){}
      showToast("Font applicato");
      requestAnimationFrame(scrollCaretIntoView);
    }

    function applyFontSize(px){
      hardFocusEditor();
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;

      // Selezione -> avvolgi in span con font-size
      try{
        const range = sel.getRangeAt(0);
        if (!range.collapsed){
          const span = document.createElement("span");
          span.style.fontSize = px + "px";
          range.surroundContents(span);
          showToast("Dimensione applicata");
          requestAnimationFrame(scrollCaretIntoView);
          return;
        }
      }catch(e){}

      // Nessuna selezione: imposta uno stile "inseribile" tramite execCommand fallback
      // (execCommand fontSize usa 1..7, quindi facciamo un trucco e poi convertiamo)
      try{
        document.execCommand("fontSize", false, "7");
        // Converti i <font size="7"> in span con px
        const fonts = editor.querySelectorAll('font[size="7"]');
        fonts.forEach(ft=>{
          const span = document.createElement("span");
          span.style.fontSize = px + "px";
          span.innerHTML = ft.innerHTML;
          ft.replaceWith(span);
        });
        
