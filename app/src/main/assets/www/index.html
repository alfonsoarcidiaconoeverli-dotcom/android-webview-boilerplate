<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>WordStudio</title>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --soft:#f7f7f8;
      --line:#e6e6e6;
      --muted:#6b7280;
      --text:#111827;
      --primary:#2563eb;
      --danger:#dc2626;

      --shadow:0 10px 26px rgba(0,0,0,.06);
      --shadow2:0 4px 14px rgba(0,0,0,.05);

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
      --kbPad: 0px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased;
      overscroll-behavior:none;
      touch-action:manipulation;
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      background:var(--bg);
    }

    /* TOPBAR: SOLO BRAND + NOME, ZERO BOTTONI (zona che nel WebView può non cliccare) */
    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding: calc(10px + var(--safeTop)) 12px 10px;
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      min-width:0;
    }
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:var(--primary);
      display:grid;place-items:center;
      color:#fff;font-weight:900;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .brand-text{ line-height:1.1; min-width:0; }
    .brand-text .title{ font-size:16px; font-weight:900; }
    .brand-text .sub{ font-size:12px; color:var(--muted); font-weight:700; }

    .nameWrap{
      flex:1;
      display:flex;
      justify-content:flex-end;
      min-width:0;
    }
    .filename{
      width:min(520px, 100%);
      height:44px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:0 14px;
      font-size:14px;
      outline:none;
      background:#fff;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
    }
    .filename:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    /* TOOLBAR: QUI CI METTIAMO TUTTO (file + formattazione) */
    .toolbarWrap{
      position:sticky;
      top: calc(68px + var(--safeTop));
      z-index:25;
      background: var(--soft);
      border-bottom:1px solid var(--line);
      pointer-events:auto;
    }
    .toolbar{
      max-width:1100px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      pointer-events:auto;
    }

    .group{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:10px;
      box-shadow: var(--shadow2);
      pointer-events:auto;
    }

    .btn{
      height:44px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 14px;
      font-weight:900;
      font-size:14px;
      color:#111827;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      pointer-events:auto;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.danger{ border-color: rgba(220,38,38,.35); color:var(--danger); }

    .chip{
      height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      padding:0 12px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .chip:active{ transform:translateY(1px); }
    .chip.on{
      border-color: rgba(37,99,235,.4);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .colorbox{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:#111827;
      display:inline-block;
    }
    input[type="color"]{
      width:44px;height:38px;
      border:none;
      background:transparent;
      padding:0;
      pointer-events:auto;
      touch-action: manipulation;
    }

    /* CONTENT */
    .content{
      flex:1;
      display:flex;
      justify-content:center;
      background:var(--soft);
      padding: 10px 12px calc(16px + var(--safeBot) + var(--kbPad));
    }
    .page{
      width:100%;
      max-width:1100px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 60vh;
    }
    .ruler{
      height:38px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(#fff, #fff) padding-box,
        repeating-linear-gradient(to right, rgba(0,0,0,.08) 0, rgba(0,0,0,.08) 1px, transparent 1px, transparent 22px);
      opacity:.45;
    }
    .editor{
      flex:1;
      padding:18px 18px 30px;
      outline:none;
      font-size:16px;
      line-height:1.55;
      color:var(--text);
      word-wrap: break-word;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      pointer-events:auto;
      touch-action: manipulation;
      user-select:text;
    }
    .editor:empty:before{
      content:"Inizia a scrivere…";
      color:#9ca3af;
    }

    /* MODALS */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.24);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 12px calc(18px + var(--safeBot));
      z-index:60;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:min(680px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead .h{ font-weight:900; font-size:16px; }
    .modalBody{ padding:12px 14px 14px; }
    .hint{ font-size:13px; color:var(--muted); font-weight:650; margin:0 0 10px; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 45vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .row{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .row .meta{ min-width:0; display:flex; flex-direction:column; gap:4px; }
    .row .name{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row .date{ font-size:12px; color:var(--muted); font-weight:700; }
    .row .actions{ display:flex; gap:8px; flex:0 0 auto; }
    .small{ height:38px; padding:0 12px; font-size:13px; }

    /* TOAST */
    .status{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(12px + var(--safeBot));
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:70;
    }
    .toast{
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(10px);
      transition:.25s ease;
      max-width:min(640px, 100%);
      text-align:center;
    }
    .toast.show{ opacity:1; transform:translateY(0); }

    @media print{
      .topbar, .toolbarWrap, .ruler, .status { display:none !important; }
      .content{ padding:0 !important; background:#fff !important; }
      .page{ border:none !important; box-shadow:none !important; border-radius:0 !important; }
      .editor{ padding:0 !important; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- TOP: niente bottoni -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo">W</div>
          <div class="brand-text">
            <div class="title">WordStudio</div>
            <div class="sub">stile Word • offline</div>
          </div>
        </div>

        <div class="nameWrap">
          <input id="fileName" class="filename" type="text" value="Documento" autocomplete="off" />
        </div>
      </div>
    </header>

    <!-- TOOLBAR: TUTTI I COMANDI QUI -->
    <div class="toolbarWrap">
      <div class="toolbar">
        <div class="group" aria-label="File">
          <button class="btn primary" id="btnSave" type="button">Salva</button>
          <button class="btn" id="btnSaveAs" type="button">Salva con nome</button>
          <button class="btn" id="btnOpen" type="button">Apri</button>
          <button class="btn" id="btnPrint" type="button">Stampa</button>
          <button class="btn danger" id="btnTrash" type="button">Cestino</button>
        </div>

        <div class="group" aria-label="Formattazione">
          <span class="chip" id="btnColor" role="button" aria-label="Colore testo">
            <span class="colorbox" id="colorBox"></span>
            <span>Colore</span>
          </span>
          <input id="colorPicker" type="color" value="#111827" aria-label="Scegli colore" />

          <button class="chip" id="btnBold" type="button"><b>B</b></button>
          <button class="chip" id="btnItalic" type="button"><i>I</i></button>
          <button class="chip" id="btnUnderline" type="button"><u>U</u></button>
          <button class="chip" id="btnStrike" type="button"><span style="text-decoration:line-through;font-weight:900;">S</span></button>

          <button class="chip" id="btnH" type="button">Titolo</button>
          <button class="chip" id="btnP" type="button">Paragrafo</button>
          <button class="chip" id="btnBullets" type="button">• Elenco</button>
        </div>
      </div>
    </div>

    <main class="content">
      <section class="page">
        <div class="ruler"></div>
        <div id="editor" class="editor" contenteditable="true" spellcheck="true"></div>
      </section>
    </main>

    <!-- Modal Apri -->
    <div class="modalBack" id="openModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Apri documento">
        <div class="modalHead">
          <div class="h">Apri documento</div>
          <button class="btn small" id="btnCloseOpen" type="button">Chiudi</button>
        </div>
        <div class="modalBody">
          <p class="hint">I documenti vengono salvati offline su questo dispositivo.</p>
          <div class="list" id="docList"></div>
        </div>
      </div>
    </div>

    <!-- Modal Cestino -->
    <div class="modalBack" id="trashModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Cestino">
        <div class="modalHead">
          <div class="h">Cestino</div>
          <button class="btn small" id="btnCloseTrash" type="button">Chiudi</button>
        </div>
        <div class="modalBody">
          <p class="hint">Ripristina o elimina definitivamente.</p>
          <div class="list" id="trashList"></div>
        </div>
      </div>
    </div>

    <div class="status"><div class="toast" id="toast"></div></div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  const editor = $("editor");
  const fileName = $("fileName");
  const toast = $("toast");

  const btnSave = $("btnSave");
  const btnSaveAs = $("btnSaveAs");
  const btnOpen = $("btnOpen");
  const btnPrint = $("btnPrint");
  const btnTrash = $("btnTrash");

  const openModal = $("openModal");
  const trashModal = $("trashModal");
  const btnCloseOpen = $("btnCloseOpen");
  const btnCloseTrash = $("btnCloseTrash");
  const docList = $("docList");
  const trashList = $("trashList");

  const colorPicker = $("colorPicker");
  const colorBox = $("colorBox");

  const btnBold = $("btnBold");
  const btnItalic = $("btnItalic");
  const btnUnderline = $("btnUnderline");
  const btnStrike = $("btnStrike");
  const btnH = $("btnH");
  const btnP = $("btnP");
  const btnBullets = $("btnBullets");

  const KEY_DOCS = "wordstudio_docs_v3";
  const KEY_TRASH = "wordstudio_trash_v3";
  const KEY_LAST = "wordstudio_last_open_v3";

  const nowISO = () => new Date().toISOString();
  const fmtDate = (iso) => {
    try{
      const d = new Date(iso);
      return d.toLocaleString("it-IT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return iso; }
  };

  const loadJSON = (k, fallback) => {
    try{
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : fallback;
    }catch(e){ return fallback; }
  };
  const saveJSON = (k, val) => localStorage.setItem(k, JSON.stringify(val));

  const normalizeName = (name) => (name || "").trim().replace(/\s+/g, " ").slice(0, 60) || "Documento";
  const getCurrentName = () => normalizeName(fileName.value);
  const getHTML = () => editor.innerHTML || "";
  const setHTML = (html) => { editor.innerHTML = html || "<p></p>"; };

  // Focus robusto
  const hardFocusEditor = () => {
    editor.focus({ preventScroll:true });
    try{
      const sel = window.getSelection();
      if (!sel) return;
      if (sel.rangeCount === 0) {
        const r = document.createRange();
        r.selectNodeContents(editor);
        r.collapse(false);
        sel.removeAllRanges();
        sel.addRange(r);
      }
    }catch(e){}
  };

  editor.addEventListener("pointerdown", () => hardFocusEditor(), { passive:true });
  editor.addEventListener("click", () => hardFocusEditor());

  // Toast
  let toastTimer = null;
  const showToast = (msg) => {
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1600);
  };

  // Storage docs
  const getDocs = () => loadJSON(KEY_DOCS, []);
  const setDocs = (arr) => saveJSON(KEY_DOCS, arr);

  const getTrash = () => loadJSON(KEY_TRASH, []);
  const setTrash = (arr) => saveJSON(KEY_TRASH, arr);

  const upsertDoc = (name, html) => {
    const docs = getDocs();
    const n = normalizeName(name);
    const idx = docs.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    const entry = { name:n, html, updatedAt: nowISO() };
    if (idx >= 0) docs[idx] = entry; else docs.unshift(entry);
    setDocs(docs);
    localStorage.setItem(KEY_LAST, n);
    return entry;
  };

  const openDocByName = (name) => {
    const n = normalizeName(name);
    const doc = getDocs().find(d => d.name.toLowerCase() === n.toLowerCase());
    if (!doc) return false;
    fileName.value = doc.name;
    setHTML(doc.html);
    localStorage.setItem(KEY_LAST, doc.name);
    setTimeout(hardFocusEditor, 80);
    return true;
  };

  const moveToTrash = (name) => {
    const n = normalizeName(name);
    const docs = getDocs();
    const idx = docs.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if (idx < 0) return false;
    const [removed] = docs.splice(idx, 1);
    setDocs(docs);

    const trash = getTrash();
    trash.unshift({ ...removed, deletedAt: nowISO() });
    setTrash(trash);
    return true;
  };

  const restoreFromTrash = (name) => {
    const n = normalizeName(name);
    const trash = getTrash();
    const idx = trash.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if (idx < 0) return false;
    const [rest] = trash.splice(idx, 1);
    setTrash(trash);
    upsertDoc(rest.name, rest.html);
    return true;
  };

  const deleteForever = (name) => {
    const n = normalizeName(name);
    const trash = getTrash();
    const idx = trash.findIndex(d => d.name.toLowerCase() === n.toLowerCase());
    if (idx < 0) return false;
    trash.splice(idx, 1);
    setTrash(trash);
    return true;
  };

  // Escape
  const escapeHTML = (str) => String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
  const escapeAttr = (str) => String(str).replace(/"/g, "&quot;");

  // Modals
  const showModal = (el) => { el.classList.add("show"); el.setAttribute("aria-hidden","false"); };
  const hideModal = (el) => { el.classList.remove("show"); el.setAttribute("aria-hidden","true"); };

  [openModal, trashModal].forEach(mod => {
    mod.addEventListener("click", (e) => { if (e.target === mod) hideModal(mod); });
  });

  const renderDocs = () => {
    const docs = getDocs();
    docList.innerHTML = "";
    if (!docs.length){
      docList.innerHTML = `<div class="row"><div class="meta"><div class="name">Nessun documento</div><div class="date">Salva un documento per vederlo qui.</div></div></div>`;
      return;
    }
    for (const d of docs){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="meta">
          <div class="name">${escapeHTML(d.name)}</div>
          <div class="date">Aggiornato: ${escapeHTML(fmtDate(d.updatedAt))}</div>
        </div>
        <div class="actions">
          <button class="btn small primary" data-open="${escapeAttr(d.name)}" type="button">Apri</button>
          <button class="btn small danger" data-trash="${escapeAttr(d.name)}" type="button">Elimina</button>
        </div>
      `;
      docList.appendChild(row);
    }
    docList.querySelectorAll("[data-open]").forEach(b => {
      b.addEventListener("click", () => {
        openDocByName(b.getAttribute("data-open"));
        hideModal(openModal);
        showToast("Documento aperto");
      });
    });
    docList.querySelectorAll("[data-trash]").forEach(b => {
      b.addEventListener("click", () => {
        if (moveToTrash(b.getAttribute("data-trash"))){
          renderDocs();
          showToast("Spostato nel cestino");
        }
      });
    });
  };

  const renderTrash = () => {
    const items = getTrash();
    trashList.innerHTML = "";
    if (!items.length){
      trashList.innerHTML = `<div class="row"><div class="meta"><div class="name">Cestino vuoto</div><div class="date">Nessun elemento eliminato.</div></div></div>`;
      return;
    }
    for (const d of items){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="meta">
          <div class="name">${escapeHTML(d.name)}</div>
          <div class="date">Eliminato: ${escapeHTML(fmtDate(d.deletedAt || d.updatedAt))}</div>
        </div>
        <div class="actions">
          <button class="btn small" data-restore="${escapeAttr(d.name)}" type="button">Ripristina</button>
          <button class="btn small danger" data-delete="${escapeAttr(d.name)}" type="button">Elimina</button>
        </div>
      `;
      trashList.appendChild(row);
    }
    trashList.querySelectorAll("[data-restore]").forEach(b => {
      b.addEventListener("click", () => {
        if (restoreFromTrash(b.getAttribute("data-restore"))){
          renderTrash();
          showToast("Ripristinato");
        }
      });
    });
    trashList.querySelectorAll("[data-delete]").forEach(b => {
      b.addEventListener("click", () => {
        if (deleteForever(b.getAttribute("data-delete"))){
          renderTrash();
          showToast("Eliminato definitivamente");
        }
      });
    });
  };

  // execCommand formatting
  const cmd = (name, value=null) => {
    hardFocusEditor();
    try{ document.execCommand(name, false, value); }catch(e){}
    hardFocusEditor();
  };

  const setChip = (el, on) => el.classList.toggle("on", !!on);
  const syncStates = () => {
    try{
      setChip(btnBold, document.queryCommandState("bold"));
      setChip(btnItalic, document.queryCommandState("italic"));
      setChip(btnUnderline, document.queryCommandState("underline"));
      setChip(btnStrike, document.queryCommandState("strikeThrough"));
    }catch(e){}
  };
  editor.addEventListener("keyup", syncStates);
  editor.addEventListener("mouseup", syncStates);
  editor.addEventListener("touchend", syncStates, { passive:true });

  // Press helper (evita problemi tap WebView)
  const onPress = (el, handler) => {
    const run = (e) => { e.preventDefault(); e.stopPropagation(); handler(); };
    el.addEventListener("pointerup", run);
    el.addEventListener("click", run);
  };

  // File actions (tutti in toolbar)
  onPress(btnSave, () => {
    upsertDoc(getCurrentName(), getHTML());
    showToast("Salvato");
  });

  onPress(btnSaveAs, () => {
    const name = prompt("Nome documento:", getCurrentName());
    if (name === null) return;
    const n = normalizeName(name);
    fileName.value = n;
    upsertDoc(n, getHTML());
    showToast("Salvato con nome");
  });

  onPress(btnOpen, () => { renderDocs(); showModal(openModal); });
  onPress(btnPrint, () => { try{ window.print(); showToast("Stampa avviata"); }catch(e){ showToast("Stampa non disponibile"); } });
  onPress(btnTrash, () => { renderTrash(); showModal(trashModal); });

  onPress(btnCloseOpen, () => hideModal(openModal));
  onPress(btnCloseTrash, () => hideModal(trashModal));

  // Formatting
  onPress(btnBold, () => { cmd("bold"); syncStates(); });
  onPress(btnItalic, () => { cmd("italic"); syncStates(); });
  onPress(btnUnderline, () => { cmd("underline"); syncStates(); });
  onPress(btnStrike, () => { cmd("strikeThrough"); syncStates(); });

  onPress(btnH, () => { cmd("formatBlock", "<h1>"); showToast("Titolo"); });
  onPress(btnP, () => { cmd("formatBlock", "<p>"); showToast("Paragrafo"); });
  onPress(btnBullets, () => { cmd("insertUnorderedList"); showToast("Elenco"); });

  colorPicker.addEventListener("input", () => {
    const c = colorPicker.value;
    colorBox.style.background = c;
    cmd("foreColor", c);
  });

  // Keyboard/viewport fix
  const setKbPadding = () => {
    const vv = window.visualViewport;
    if (!vv) return;
    const kb = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
    document.documentElement.style.setProperty("--kbPad", kb + "px");
  };

  const scrollCaretIntoView = () => {
    try{
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const r = sel.getRangeAt(0).cloneRange();
      const rect = r.getBoundingClientRect();
      if (!rect || !rect.height) return;

      const vv = window.visualViewport;
      const bottomLimit = (vv ? vv.height : window.innerHeight) - 12;
      if (rect.bottom > bottomLimit){
        const delta = rect.bottom - bottomLimit + 18;
        editor.scrollTop += delta;
      }
    }catch(e){}
  };

  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", () => { setKbPadding(); setTimeout(scrollCaretIntoView, 60); });
    window.visualViewport.addEventListener("scroll", () => { setKbPadding(); });
  }
  window.addEventListener("resize", () => { setKbPadding(); setTimeout(scrollCaretIntoView, 60); });
  editor.addEventListener("input", () => setTimeout(scrollCaretIntoView, 0));

  // Boot
  const boot = () => {
    if (!editor.innerHTML.trim()) editor.innerHTML = "<p></p>";

    const last = localStorage.getItem(KEY_LAST);
    if (last && openDocByName(last)){
      showToast("Ripreso: " + last);
    }else{
      showToast("Pronto");
      setTimeout(hardFocusEditor, 120);
    }

    setKbPadding();
  };

  boot();
})();
</script>
</body>
</html>
